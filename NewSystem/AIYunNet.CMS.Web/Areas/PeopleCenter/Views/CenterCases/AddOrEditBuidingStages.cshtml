@model AIYunNet.CMS.Domain.Model.WebBuiding
@using AIYunNet.CMS.Common.Utility;
@{
	ViewBag.Title = "AddBuidingStages";
	Layout = "~/Areas/PeopleCenter/Views/Shared/_LayoutCenter.cshtml";
	string[] stagesIDArr = null;
	string[] stagesTextArr = null;
	if (Model != null && !string.IsNullOrWhiteSpace(Model.constructionstageID))
	{
		stagesIDArr = Model.constructionstageID.Split(',');
		stagesTextArr = Model.constructionstage.TrimEnd(',').Split(',');
	}
	IEnumerable<SelectListItem> workPositionList = ViewBag.workPositionList as IEnumerable<SelectListItem>;
}
<style>
	#stageCaseForm textarea, input {
		border: 1px solid #ccc;
		border-radius: 4px;
		width: 100%;
	}

	#stageCaseForm .set_div > input {
		width: 10%;
		height: 40px;
	}

	#stageCaseForm .set_l {
		margin-right: 10px;
		margin-left: 10px;
	}

	#stageCaseForm .div_workstage span {
		padding: 10px;
	}

	#stageCaseForm .div_workstage input {
		width: 20px;
		height: 20px;
		display: inline;
		margin-right: 5px;
	}
</style>
<div class="centers_mr">
	<div class="centers_r_items">
		<div class="upload-left">
			<form id="stageCaseForm">
				@Html.HiddenFor(m => m.BuidingID)
				<div class="req-push-title"><p class="req-name"><i></i><span>填写案例信息</span></p></div>
				<div class="form-box-list">
					<div class="tab-l"><span class="form-box-label"><i>*</i>作品标题</span></div>
					<div class="tab-r">
						@Html.TextBoxFor(m => m.BuidingTitle, new { @class = "form-ipt-txt", placeholder = "请简单写出您的标题（5-20个字)" })
					</div>
					<div class="clearfiexd"></div>
				</div>
				<div class="form-box-list">
					<div class="tab-l"><span class="form-box-label">简单介绍</span></div>
					<div class="tab-r">
						@Html.TextAreaFor(m => m.BuidingBrief, new { row = "4", col = "10" })
					</div>
					<div class="clearfiexd"></div>
				</div>
				<div class="form-box-list">
					<div class="tab-l">
						<span class="form-box-label">详细介绍</span>
					</div>
					<div class="tab-r">
						@Html.TextAreaFor(m => m.BuidingInfo, new { row = "4", col = "10" })
					</div>
					<div class="clearfiexd"></div>
				</div>
				<div class="form-box-list">
					<div class="tab-l">
						<span class="form-box-label">项目情况</span>
					</div>
					<div class="tab-r">
						<span class="set_l">价格</span>
						@Html.TextBoxFor(m => m.Price, new { style = "width:30%" })
						<span class="set_l">面积</span>
						@Html.TextBoxFor(m => m.Space, new { style = "width:30%" })
					</div>
					<div class="clearfiexd"></div>
				</div>
				<div class="form-box-list">
					<div class="tab-l"><span class="form-box-label"><i>*</i>上传图片</span></div>
					<div class="tab-r">
						<div class="upimg">
							@if (string.IsNullOrWhiteSpace(Model.thumbnailImage))
							{
								<img src="" id="ImgLook" style="width:380px;height:280px;">
							}
							else
							{
								<img src="@AppSettingsHelper.ImgUrl@Model.thumbnailImage" id="ImgLook" style="width:380px;height:280px;">
							}
							<input class="btn btn-default" style="width:100px;margin-left:10px;" type='button' value='选择图片' onclick='javascript: $("#ImageUpload").click();' />
							<input type="file" name="ImageUpload" id="ImageUpload" multiple style="display:none;" />
							<a class="btn btn-primary" style="color:#fff" href="javascript:void(0);" id="BtnUpload">上传图片</a>
							<span class="form-sm" style="display:block">尺寸大小380px*280px图片大小不超过300K</span>
						</div>
					</div>				
					<input type="hidden" name="CaseImageBig" value="@Model.BuidingImage" id="ImageUrl" />
					<input type="hidden" name="thumbnailImage" value="@Model.thumbnailImage" id="thumbnailImage" />
					<div class="clearfiexd"></div>
				</div>
				<div class="form-box-list">
					<div class="tab-l">
						<span class="form-box-label">阶段设置(<span style="color:#ff0000">最多设置6个</span>)</span>
					</div>
					<div class="tab-r div_workstage">
						@if (workPositionList != null && workPositionList.Count() > 0)
						{
							foreach (SelectListItem item in workPositionList)
							{
								<span>
									@if (stagesIDArr != null && stagesIDArr.Contains(item.Value))
									{
										<input type="checkbox" name="workPosition" checked="checked" value="@item.Value" data-text="@item.Text" />@item.Text
									}
									else
									{
										<input type="checkbox" name="workPosition" value="@item.Value" data-text="@item.Text" />@item.Text
									}
								</span>
							}
						}
						<input id="selectedStagesCode" type="hidden" value="@Model.constructionstageID" />
						<input id="selectedStagesText" type="hidden" value="@Model.constructionstage" />
						<div id="selectedStages">
							@if (stagesTextArr != null)
							{
								foreach (string t in stagesTextArr)
								{
									<span style="background-color:#a1e6ff;margin-right:5px;">@t</span>
								}
							}
						</div>
					</div>
					<div class="clearfiexd"></div>
				</div>
				<div class="form-box-list">
					<div class="tab-l">
						<span class="form-box-label">设置</span>
					</div>
					<div class="tab-r set_div">
						<span class="set_l">显示顺序</span>
						@Html.TextBoxFor(m => m.ShowOrder)
						<span class="set_l">热门推荐</span>
						@Html.CheckBoxFor(m => m.IsHot, new { style = "width:20px;height:20px;" })
						<span class="set_l">置顶显示</span>
						@Html.CheckBoxFor(m => m.IsTop, new { style = "width:20px;height:20px;" })
					</div>
					<div class="clearfiexd"></div>
				</div>
				<div class="form-box-list">
					<a id="btnSubmit" class="btn-submit" href="javascript:void()">提交发布</a>
				</div>
			</form>
		</div>
	</div>
</div>
@section Scripts{
<link href="~/Content/Plugins/webupload/jQueryfileupload/css/jquery.fileupload.css" rel="stylesheet" />
<link href="~/Content/Plugins/webupload/jQueryfileupload/css/jquery.fileupload-ui.css" rel="stylesheet" />
<script src="~/Content/Plugins/webupload/jQueryfileupload/js/jquery.fileupload.js"></script>
<script src="~/Content/Plugins/webupload/jQueryfileupload/js/jquery.fileupload-ui.js"></script>
<script src="~/Content/Plugins/webupload/jQueryfileupload/js/jquery.iframe-transport.js"></script>
	<script>
		$(function ()
		{
			var selectedStages = [];
			var existedIDs = $("#selectedStagesCode").val();
			var existedTexts = $("#selectedStagesText").val();
			if (existedIDs)
			{
				var existedIDArr = existedIDs.substring(0, existedIDs.length - 1).split(',');
				var existedTextArr = existedTexts.substring(0, existedTexts.length - 1).split(',');
				for (var i = 0; i < existedIDArr.length; i++)
				{
					selectedStages.push({ "code": existedIDArr[i], "text": existedTextArr[i] });
				}
			}

			$("input[name=workPosition]").click(function ()
			{
				var chk = $(this);
				if (chk.prop("checked"))
				{
					selectedStages.push({ "code": chk.val(), "text": chk.data("text") });
				} else
				{
					var code = chk.val();
					var index = selectedStages.findIndex(function (item)
					{
						return item.code == code;
					});
					selectedStages.splice(index, 1);
				}
				var html = '';
				var codestr = '';
				var cdoeText = '';
				for (var i = 0; i < selectedStages.length; i++)
				{
					codestr += selectedStages[i].code + ',';
					cdoeText += selectedStages[i].text + ',';
					html += '<span style="background-color:#a1e6ff;margin-right:5px;">' + selectedStages[i].text + '</span>';
				}
				$("#selectedStagesText").val(cdoeText);
				$("#selectedStagesCode").val(codestr);
				$("#selectedStages").html(html);
			});

			$("#btnSubmit").click(function ()
			{
				var BuidingTitle = $("#BuidingTitle").val();
				if (!BuidingTitle)
				{
					alert("标题不能为空");
					$("#BuidingTitle").focus();
					return;
				}
				var BuidingID = $("#BuidingID").val();
				var BuidingBrief = $("#BuidingBrief").val();
				var BuidingInfo = $("#BuidingInfo").val();
				var Price = $("#Price").val();
				var Space = $("#Space").val();
				var selectedStagesCode = $("#selectedStagesCode").val();
				var selectedStagesText = $("#selectedStagesText").val();
				var ShowOrder = $("#ShowOrder").val();
				var IsHot = $("#IsHot").prop("checked") ? 1 : 0;
				var IsTop = $("#IsTop").prop("checked") ? 1 : 0;
				var BuidingImage = $("#ImageUrl").val();
				var thumbnailImage = $("#thumbnailImage").val();
				$.ajax({
					type: "post",
					url: "/PeopleCenter/CenterCases/AddOrEditBuidingStages",
					data: {
						BuidingID: BuidingID,
						BuidingTitle: BuidingTitle,
						BuidingBrief: BuidingBrief,
						BuidingInfo: BuidingInfo,
						Price: Price,
						Space: Space,
						ConstructionstageID: selectedStagesCode,
						Constructionstage: selectedStagesText,
						ShowOrder: ShowOrder,
						IsHot: IsHot,
						IsTop: IsTop,
						BuidingImage: BuidingImage,
						thumbnailImage: thumbnailImage
					},
					success: function (data)
					{
						if (data.RetCode == 1)
						{
							if (BuidingID > 0)
							{
								alert("修改成功！");
							} else
							{
								alert("添加成功！");
							}
							window.location.href = "/PeopleCenter/CenterCases/BuidingStagesList";

						}
					}

				});
			});

			InitUploadPlugin();

		})

		function InitUploadPlugin()
		{
			var jqXHRData = new Array();
			initFileUpload();
			$('#BtnUpload').on('click', function () {
				if (jqXHRData.length > 0) {
					for (var i = 0; i < jqXHRData.length; i++) {
						jqXHRData[i].submit();
					}
					return true;
				} else {
					return false;
				}
			});

			function initFileUpload() {
				$('#ImageUpload').fileupload({
					url: '/PeopleCenter/UploadPic/CenterPictrueUpload',
					dataType: 'json',
					add: function (e, data) {
						jqXHRData.push(data);
					},
					done: function (event, data) {
						if (data.result.isUploaded) {
							//$("#ImageUpload").val(data.result.message);
							$("#ImageUrl").val(data.result.message);
							$("#ImgLook").attr("src", "@AppSettingsHelper.ImgUrl" + data.result.message);
							$("#thumbnailImage").val(data.result.thumbnailmessage);
						} else {
							alert(data.result.message);
						}
					},
					fail: function (event, data) {
						if (data.files[0].error) {
							alert(data.files[0].error);
						}
					},
					progressall: function (e, data) {
						var progress = parseInt(data.loaded / data.total * 100, 10);
						//$('#progress .bar').css('width', progress + '%');
					}
				});
			}
		}
	</script>
}

